<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#f03333" />
    <meta name="description" content="Calcola il voto necessario per raggiungere la tua media target" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MediaHo" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
    <title>Calcoli & Previsioni - che media ho?</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --text: #f1e4e4;
        --background: #130909;
        --primary: #f03333;
        --secondary: #7f2929;
        --accent: #c83737;
        --success: #4caf50;
        --warning: #ffa500;
      }

      :root[data-theme="light"] {
        --text: #1a0a0a;
        --background: #fef8f8;
        --primary: #f03333;
        --secondary: #f5cccc;
        --accent: #c83737;
        --success: #4caf50;
        --warning: #ffa500;
      }

      body {
        margin: 0;
        padding: 0;
        padding-bottom: calc(72px + env(safe-area-inset-bottom));
        min-height: 100vh;
        background: var(--background);
        color: var(--text);
        font-family: Arial, Helvetica, sans-serif;
      }

      .header-section {
        text-align: center;
        padding: 32px 20px 24px;
      }

      .page-title {
        font-size: 28px;
        font-weight: bold;
        color: var(--text);
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 14px;
        color: var(--text);
        opacity: 0.7;
        line-height: 1.5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px 40px;
      }

      .calculator-card {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .calculator-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: var(--secondary);
        opacity: 0.15;
        z-index: -1;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
        font-size: 14px;
      }

      .form-select, .form-input {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--secondary);
        border-radius: 8px;
        background: var(--background);
        color: var(--text);
        font-size: 16px;
        font-family: inherit;
        transition: border-color 0.3s ease;
      }

      .form-select:focus, .form-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .form-input[type="number"] {
        appearance: textfield;
      }

      .form-input[type="number"]::-webkit-outer-spin-button,
      .form-input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .calculate-btn {
        width: 100%;
        padding: 14px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .calculate-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
      }

      .calculate-btn:active {
        transform: translateY(0);
      }

      .calculate-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .result-card {
        display: none;
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        border-left: 4px solid var(--accent);
      }

      .result-card.show {
        display: block;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .result-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: var(--secondary);
        opacity: 0.2;
        z-index: -1;
      }

      .result-card.success {
        border-left-color: var(--success);
      }

      .result-card.warning {
        border-left-color: var(--warning);
      }

      .result-card.error {
        border-left-color: var(--primary);
      }

      .result-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .result-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
      }

      .result-card.success .result-icon {
        background: var(--success);
      }

      .result-card.warning .result-icon {
        background: var(--warning);
      }

      .result-card.error .result-icon {
        background: var(--primary);
      }

      .result-title {
        font-size: 20px;
        font-weight: bold;
        color: var(--text);
      }

      .result-content {
        margin-bottom: 16px;
      }

      .result-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--secondary);
      }

      .result-row:last-child {
        border-bottom: none;
      }

      .result-label {
        font-size: 14px;
        opacity: 0.8;
      }

      .result-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--accent);
      }

      .result-value.highlight {
        font-size: 24px;
        color: var(--primary);
      }

      .result-message {
        padding: 16px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
        font-size: 14px;
        line-height: 1.6;
        text-align: center;
      }

      .info-box {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
        border-left: 4px solid var(--accent);
      }

      .info-box::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background-color: var(--secondary);
        opacity: 0.2;
        z-index: -1;
      }

      .info-box-title {
        font-weight: bold;
        color: var(--accent);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .info-box-content {
        font-size: 14px;
        line-height: 1.6;
        opacity: 0.9;
      }

      .tabs-container {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
      }

      .tab-button {
        background: transparent;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.6;
        border-bottom: 3px solid transparent;
        font-family: inherit;
      }

      .tab-button:hover {
        opacity: 0.8;
      }

      .tab-button.active {
        opacity: 1;
        color: var(--accent);
        border-bottom-color: var(--accent);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .grades-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .grade-input-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .grade-input-small {
        width: 80px;
        padding: 8px;
        border: 2px solid var(--secondary);
        border-radius: 8px;
        background: var(--background);
        color: var(--text);
        font-size: 14px;
        font-family: inherit;
      }

      .grade-input-small:focus {
        outline: none;
        border-color: var(--accent);
      }

      .remove-grade-btn {
        background: var(--primary);
        border: none;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s ease;
      }

      .remove-grade-btn:hover {
        transform: scale(1.1);
        opacity: 0.9;
      }

      .add-grade-btn {
        background: var(--accent);
        border: 2px solid var(--accent);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
        margin-top: 8px;
      }

      .add-grade-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }

      .error-notification {
        display: none;
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--primary);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: slideDown 0.3s ease;
        max-width: 90%;
        text-align: center;
      }

      .error-notification.show {
        display: block;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translate(-50%, -20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }

      .theme-toggle {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--secondary);
        border: 2px solid var(--accent);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 100;
      }

      .theme-toggle:hover {
        transform: scale(1.1);
        background: var(--accent);
      }

      .theme-toggle svg {
        width: 24px;
        height: 24px;
        fill: var(--text);
      }

      /* Bottom Navigation Bar */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 72px;
        background: var(--background);
        box-shadow: 0 -4px 12px rgba(240, 51, 51, 0.3);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding-top: 8px;
        padding-bottom: env(safe-area-inset-bottom);
      }

      @media (max-width: 768px) {
        .bottom-nav {
          left: 12px;
          right: 12px;
          bottom: max(16px, env(safe-area-inset-bottom));
          border-radius: 20px;
          box-shadow: 0 -4px 12px rgba(240, 51, 51, 0.3), 0 4px 20px rgba(0, 0, 0, 0.3);
        }
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: var(--text);
        transition: all 0.3s ease;
        opacity: 0.6;
        flex: 1;
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
      }

      .nav-item.active {
        opacity: 1;
      }

      .nav-item:hover {
        opacity: 1;
      }

      .nav-icon {
        width: 28px;
        height: 28px;
        margin-bottom: 4px;
        stroke: currentColor;
        fill: none;
      }

      .nav-item.active .nav-icon {
        fill: var(--accent);
        stroke: var(--accent);
      }

      .nav-label {
        font-size: 12px;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .page-title {
          font-size: 24px;
        }

        .theme-toggle {
          top: auto;
          bottom: calc(96px + env(safe-area-inset-bottom));
          right: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Error Notification -->
    <div class="error-notification" id="errorNotification"></div>

    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" x2="12" y1="1" y2="3"/>
        <line x1="12" x2="12" y1="21" y2="23"/>
        <line x1="4.22" x2="5.64" y1="4.22" y2="5.64"/>
        <line x1="18.36" x2="19.78" y1="18.36" y2="19.78"/>
        <line x1="1" x2="3" y1="12" y2="12"/>
        <line x1="21" x2="23" y1="12" y2="12"/>
        <line x1="4.22" x2="5.64" y1="19.78" y2="18.36"/>
        <line x1="18.36" x2="19.78" y1="5.64" y2="4.22"/>
      </svg>
    </button>

    <div class="header-section">
      <h1 class="page-title">üéØ Calcoli & Previsioni</h1>
      <p class="page-subtitle">Calcola obiettivi e prevedi l'impatto dei voti sulla tua media!</p>
    </div>

    <div class="container">
      <!-- Tabs -->
      <div class="tabs-container">
        <button class="tab-button active" onclick="switchTab('goal')">
          üéØ Obiettivo
        </button>
        <button class="tab-button" onclick="switchTab('predict')">
          üîÆ Previsione
        </button>
        <button class="tab-button" onclick="switchTab('overall')">
          üåç Media Generale
        </button>
      </div>

      <!-- Goal Calculator Tab -->
      <div class="tab-content active" id="goalTab">
        <!-- Calculator Form -->
        <div class="calculator-card">
          <form id="goalForm">
            <div class="form-group">
              <label class="form-label" for="periodSelectGoal">Periodo</label>
              <select class="form-select" id="periodSelectGoal" required>
                <option value="">Seleziona un periodo...</option>
                {% for period in grades_avr.keys() if period != 'all_avr' %}
                <option value="{{ period }}">Periodo {{ period }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="subjectSelectGoal">Materia</label>
              <select class="form-select" id="subjectSelectGoal" required disabled>
                <option value="">Prima seleziona un periodo...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="targetAverage">Media Target <span id="targetRangeLabel">(1-10)</span></label>
              <input 
                type="number" 
                class="form-input" 
                id="targetAverage" 
                min="1" 
                max="10" 
                step="0.1" 
                placeholder="Es: 7.5"
                required
              />
              <small id="targetHelp" style="display: block; margin-top: 6px; font-size: 12px; opacity: 0.7;"></small>
            </div>

            <div class="form-group">
              <label class="form-label">
                Numero di voti da prendere
                <span style="font-size: 12px; opacity: 0.7; font-weight: normal;">(aggiungi pi√π voti per una pianificazione migliore)</span>
              </label>
              <div class="grades-input-container" id="gradesInputContainer">
                <div class="grade-input-group">
                  <span style="font-size: 14px; opacity: 0.8;">1 voto</span>
                </div>
              </div>
              <button type="button" class="add-grade-btn" onclick="addGradeInput()">+ Aggiungi voto</button>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtnGoal">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              Calcola
            </button>
          </form>
        </div>

        <!-- Result Card for Goal -->
        <div class="result-card" id="resultCardGoal">
          <div class="result-header">
            <div class="result-icon" id="resultIconGoal">
              <span id="resultEmojiGoal">üéØ</span>
            </div>
            <h2 class="result-title" id="resultTitleGoal">Risultato</h2>
          </div>
          <div class="result-content" id="resultContentGoal">
            <div class="result-row">
              <span class="result-label">Media Attuale</span>
              <span class="result-value" id="currentAverageGoal">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Media Target</span>
              <span class="result-value" id="targetAverageDisplay">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Voti Necessari</span>
              <span class="result-value highlight" id="requiredGradesGoal">-</span>
            </div>
          </div>
          <div class="result-message" id="resultMessageGoal">
            Completa il form per vedere i risultati
          </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
          <div class="info-box-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            Come funziona?
          </div>
          <div class="info-box-content">
            Il calcolatore usa la formula della media aritmetica per determinare 
            quali voti devi ottenere nei prossimi test per raggiungere la tua media target. 
            Puoi pianificare anche per pi√π voti futuri! Nota: tutti i voti calcolati avranno lo stesso valore medio.
          </div>
        </div>
      </div>

      <!-- Predict Calculator Tab -->
      <div class="tab-content" id="predictTab">
        <!-- Calculator Form for Predict -->
        <div class="calculator-card">
          <form id="predictForm">
            <div class="form-group">
              <label class="form-label" for="periodSelectPredict">Periodo</label>
              <select class="form-select" id="periodSelectPredict" required>
                <option value="">Seleziona un periodo...</option>
                {% for period in grades_avr.keys() if period != 'all_avr' %}
                <option value="{{ period }}">Periodo {{ period }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="subjectSelectPredict">Materia</label>
              <select class="form-select" id="subjectSelectPredict" required disabled>
                <option value="">Prima seleziona un periodo...</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">
                Voti che pensi di prendere
                <span style="font-size: 12px; opacity: 0.7; font-weight: normal;">(aggiungi uno o pi√π voti per vedere l'impatto)</span>
              </label>
              <div class="grades-input-container" id="predictGradesContainer">
                <div class="grade-input-group">
                  <input 
                    type="number" 
                    class="grade-input-small predict-grade-input" 
                    min="1" 
                    max="10" 
                    step="0.5" 
                    placeholder="Voto"
                    required
                  />
                </div>
              </div>
              <button type="button" class="add-grade-btn" onclick="addPredictGradeInput()">+ Aggiungi voto</button>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtnPredict">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              Prevedi
            </button>
          </form>
        </div>

        <!-- Result Card for Predict -->
        <div class="result-card" id="resultCardPredict">
          <div class="result-header">
            <div class="result-icon" id="resultIconPredict">
              <span id="resultEmojiPredict">üîÆ</span>
            </div>
            <h2 class="result-title" id="resultTitlePredict">Previsione</h2>
          </div>
          <div class="result-content">
            <div class="result-row">
              <span class="result-label">Media Attuale</span>
              <span class="result-value" id="currentAveragePredict">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Media Prevista</span>
              <span class="result-value highlight" id="predictedAverage">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Variazione</span>
              <span class="result-value" id="averageChange">-</span>
            </div>
          </div>
          <div class="result-message" id="resultMessagePredict">
            Completa il form per vedere la previsione
          </div>
        </div>

        <!-- Info Box -->
        <div class="info-box">
          <div class="info-box-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            Come funziona?
          </div>
          <div class="info-box-content">
            La previsione calcola come cambier√† la tua media se ricevi i voti che inserisci.
            Puoi aggiungere pi√π voti per simulare scenari diversi e vedere l'impatto sulla tua media!
          </div>
        </div>
      </div>

      <!-- Overall Average Tab -->
      <div class="tab-content" id="overallTab">
        <!-- Tabs within overall average -->
        <div class="tabs-container" style="margin-bottom: 20px; border-bottom: 1px solid var(--secondary); padding-bottom: 0;">
          <button class="tab-button active" onclick="switchOverallSubTab('overallGoal')" style="font-size: 14px; padding: 10px 16px;">
            üéØ Obiettivo
          </button>
          <button class="tab-button" onclick="switchOverallSubTab('overallPredict')" style="font-size: 14px; padding: 10px 16px;">
            üîÆ Previsione
          </button>
        </div>

        <!-- Overall Goal Sub-tab -->
        <div class="tab-content active" id="overallGoalTab">
          <div class="calculator-card">
            <form id="overallGoalForm">
              <div class="form-group">
                <label class="form-label" for="periodSelectOverallGoal">Periodo</label>
                <select class="form-select" id="periodSelectOverallGoal" required>
                  <option value="">Seleziona un periodo...</option>
                  {% for period in grades_avr.keys() if period != 'all_avr' %}
                  <option value="{{ period }}">Periodo {{ period }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="subjectSelectOverallGoal">Materia</label>
                <select class="form-select" id="subjectSelectOverallGoal" required disabled>
                  <option value="">Prima seleziona un periodo...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="targetOverallAverage">Media Generale Target <span id="targetOverallRangeLabel">(1-10)</span></label>
                <input 
                  type="number" 
                  class="form-input" 
                  id="targetOverallAverage" 
                  min="1" 
                  max="10" 
                  step="0.1" 
                  placeholder="Es: 7.5"
                  required
                />
                <small id="targetOverallHelp" style="display: block; margin-top: 6px; font-size: 12px; opacity: 0.7;"></small>
              </div>

              <div class="form-group">
                <label class="form-label">
                  Numero di voti da prendere nella materia selezionata
                  <span style="font-size: 12px; opacity: 0.7; font-weight: normal;">(per raggiungere la media generale)</span>
                </label>
                <div class="grades-input-container" id="overallGoalGradesContainer">
                  <div class="grade-input-group">
                    <span style="font-size: 14px; opacity: 0.8;">1 voto</span>
                  </div>
                </div>
                <button type="button" class="add-grade-btn" onclick="addOverallGoalGradeInput()">+ Aggiungi voto</button>
              </div>

              <button type="submit" class="calculate-btn" id="calculateBtnOverallGoal">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Calcola
              </button>
            </form>
          </div>

          <!-- Result Card for Overall Goal -->
          <div class="result-card" id="resultCardOverallGoal">
            <div class="result-header">
              <div class="result-icon" id="resultIconOverallGoal">
                <span id="resultEmojiOverallGoal">üéØ</span>
              </div>
              <h2 class="result-title" id="resultTitleOverallGoal">Risultato</h2>
            </div>
            <div class="result-content">
              <div class="result-row">
                <span class="result-label">Media Generale Attuale</span>
                <span class="result-value" id="currentOverallAverageGoal">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Media Generale Target</span>
                <span class="result-value" id="targetOverallAverageDisplay">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Voti Necessari</span>
                <span class="result-value highlight" id="requiredOverallGrades">-</span>
              </div>
            </div>
            <div class="result-message" id="resultMessageOverallGoal">
              Completa il form per vedere i risultati
            </div>
          </div>

          <!-- Info Box -->
          <div class="info-box">
            <div class="info-box-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              Come funziona?
            </div>
            <div class="info-box-content">
              Calcola quali voti ti servono in una materia specifica per raggiungere una 
              media generale target. La media generale include tutti i voti di tutte le materie 
              in tutti i periodi. Utile per pianificare i tuoi obiettivi a lungo termine!
            </div>
          </div>
        </div>

        <!-- Overall Predict Sub-tab -->
        <div class="tab-content" id="overallPredictTab">
          <div class="calculator-card">
            <form id="overallPredictForm">
              <div class="form-group">
                <label class="form-label" for="periodSelectOverallPredict">Periodo</label>
                <select class="form-select" id="periodSelectOverallPredict" required>
                  <option value="">Seleziona un periodo...</option>
                  {% for period in grades_avr.keys() if period != 'all_avr' %}
                  <option value="{{ period }}">Periodo {{ period }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="subjectSelectOverallPredict">Materia</label>
                <select class="form-select" id="subjectSelectOverallPredict" required disabled>
                  <option value="">Prima seleziona un periodo...</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  Voti che pensi di prendere nella materia selezionata
                  <span style="font-size: 12px; opacity: 0.7; font-weight: normal;">(vedi impatto sulla media generale)</span>
                </label>
                <div class="grades-input-container" id="overallPredictGradesContainer">
                  <div class="grade-input-group">
                    <input 
                      type="number" 
                      class="grade-input-small overall-predict-grade-input" 
                      min="1" 
                      max="10" 
                      step="0.5" 
                      placeholder="Voto"
                      required
                    />
                  </div>
                </div>
                <button type="button" class="add-grade-btn" onclick="addOverallPredictGradeInput()">+ Aggiungi voto</button>
              </div>

              <button type="submit" class="calculate-btn" id="calculateBtnOverallPredict">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
                Prevedi
              </button>
            </form>
          </div>

          <!-- Result Card for Overall Predict -->
          <div class="result-card" id="resultCardOverallPredict">
            <div class="result-header">
              <div class="result-icon" id="resultIconOverallPredict">
                <span id="resultEmojiOverallPredict">üîÆ</span>
              </div>
              <h2 class="result-title" id="resultTitleOverallPredict">Previsione</h2>
            </div>
            <div class="result-content">
              <div class="result-row">
                <span class="result-label">Media Generale Attuale</span>
                <span class="result-value" id="currentOverallAveragePredict">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Media Generale Prevista</span>
                <span class="result-value highlight" id="predictedOverallAverage">-</span>
              </div>
              <div class="result-row">
                <span class="result-label">Variazione</span>
                <span class="result-value" id="overallAverageChange">-</span>
              </div>
            </div>
            <div class="result-message" id="resultMessageOverallPredict">
              Completa il form per vedere la previsione
            </div>
          </div>

          <!-- Info Box -->
          <div class="info-box">
            <div class="info-box-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="16" x2="12" y2="12"/>
                <line x1="12" y1="8" x2="12.01" y2="8"/>
              </svg>
              Come funziona?
            </div>
            <div class="info-box-content">
              La previsione calcola come cambier√† la tua media generale se ricevi i voti 
              che inserisci in una materia specifica. La media generale include tutti i voti 
              di tutte le materie in tutti i periodi. Utile per capire l'impatto reale dei voti futuri!
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
      <a href="/grades" class="nav-item">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
          <polyline points="9 22 9 12 15 12 15 22"/>
        </svg>
        <span class="nav-label">Medie</span>
      </a>
      <a href="/charts" class="nav-item">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="20" x2="18" y2="10"/>
          <line x1="12" y1="20" x2="12" y2="4"/>
          <line x1="6" y1="20" x2="6" y2="14"/>
        </svg>
        <span class="nav-label">Grafici</span>
      </a>
      <a href="/goal" class="nav-item active">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"/>
          <circle cx="12" cy="12" r="6"/>
          <circle cx="12" cy="12" r="2"/>
        </svg>
        <span class="nav-label">Calcoli</span>
      </a>
      <a href="/export" class="nav-item">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        <span class="nav-label">Esporta</span>
      </a>
      <a href="/settings" class="nav-item">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
        <span class="nav-label">Impostazioni</span>
      </a>
      <button type="button" class="nav-item" id="logoutNavBtn">
        <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
        <span class="nav-label">Esci</span>
      </button>
    </nav>

    <script>
      // Store grades data from server
      const gradesData = {{ grades_avr | tojson | safe }};
      
      // Track number of grades for goal calculator
      let numGradesGoal = 1;
      let numGradesPredict = 1;
      let numGradesOverallGoal = 1;
      let numGradesOverallPredict = 1;

      // Theme management
      const themeToggle = document.getElementById('themeToggle');
      const root = document.documentElement;
      
      function getSystemTheme() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
          return 'light';
        }
        return 'dark';
      }
      
      const savedTheme = localStorage.getItem('theme');
      const initialTheme = savedTheme || getSystemTheme();
      
      if (initialTheme === 'light') {
        root.setAttribute('data-theme', 'light');
      }
      
      themeToggle.addEventListener('click', () => {
        const currentTheme = root.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        if (newTheme === 'light') {
          root.setAttribute('data-theme', 'light');
        } else {
          root.removeAttribute('data-theme');
        }
        
        localStorage.setItem('theme', newTheme);
      });

      // Tab switching
      function switchTab(tabName) {
        // Hide all tabs
        document.getElementById('goalTab').classList.remove('active');
        document.getElementById('predictTab').classList.remove('active');
        document.getElementById('overallTab').classList.remove('active');
        
        // Deactivate all tab buttons (only top-level tabs)
        const tabButtons = document.querySelectorAll('.tabs-container:first-of-type .tab-button');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        
        // Show selected tab
        if (tabName === 'goal') {
          document.getElementById('goalTab').classList.add('active');
          tabButtons[0].classList.add('active');
        } else if (tabName === 'predict') {
          document.getElementById('predictTab').classList.add('active');
          tabButtons[1].classList.add('active');
        } else if (tabName === 'overall') {
          document.getElementById('overallTab').classList.add('active');
          tabButtons[2].classList.add('active');
        }
      }

      // Sub-tab switching for overall average tab
      function switchOverallSubTab(subTabName) {
        // Hide all sub-tabs
        document.getElementById('overallGoalTab').classList.remove('active');
        document.getElementById('overallPredictTab').classList.remove('active');
        
        // Deactivate all sub-tab buttons
        const subTabButtons = document.querySelectorAll('#overallTab .tabs-container .tab-button');
        subTabButtons.forEach(btn => btn.classList.remove('active'));
        
        // Show selected sub-tab
        if (subTabName === 'overallGoal') {
          document.getElementById('overallGoalTab').classList.add('active');
          subTabButtons[0].classList.add('active');
        } else if (subTabName === 'overallPredict') {
          document.getElementById('overallPredictTab').classList.add('active');
          subTabButtons[1].classList.add('active');
        }
      }

      // Helper function to show error notification
      function showError(message) {
        const notification = document.getElementById('errorNotification');
        notification.textContent = message;
        notification.classList.add('show');
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // Helper function for Italian pluralization of "voto"
      function pluralizeVoto(count) {
        return count === 1 ? 'voto' : 'voti';
      }

      // Add grade input for goal calculator
      function addGradeInput() {
        numGradesGoal++;
        const container = document.getElementById('gradesInputContainer');
        const gradeGroup = document.createElement('div');
        gradeGroup.className = 'grade-input-group';
        gradeGroup.innerHTML = `
          <span style="font-size: 14px; opacity: 0.8;">${numGradesGoal} ${pluralizeVoto(numGradesGoal)}</span>
          <button type="button" class="remove-grade-btn" onclick="removeGradeInput(this)">√ó</button>
        `;
        container.appendChild(gradeGroup);
      }

      function removeGradeInput(btn) {
        if (numGradesGoal > 1) {
          btn.parentElement.remove();
          numGradesGoal--;
          // Update labels
          const groups = document.querySelectorAll('#gradesInputContainer .grade-input-group');
          groups.forEach((group, index) => {
            const span = group.querySelector('span');
            if (span) {
              span.textContent = `${index + 1} ${pluralizeVoto(index + 1)}`;
            }
          });
        }
      }

      // Add grade input for predict calculator
      function addPredictGradeInput() {
        numGradesPredict++;
        const container = document.getElementById('predictGradesContainer');
        const gradeGroup = document.createElement('div');
        gradeGroup.className = 'grade-input-group';
        gradeGroup.innerHTML = `
          <input 
            type="number" 
            class="grade-input-small predict-grade-input" 
            min="1" 
            max="10" 
            step="0.5" 
            placeholder="Voto"
            required
          />
          <button type="button" class="remove-grade-btn" onclick="removePredictGradeInput(this)">√ó</button>
        `;
        container.appendChild(gradeGroup);
      }

      function removePredictGradeInput(btn) {
        if (numGradesPredict > 1) {
          btn.parentElement.remove();
          numGradesPredict--;
        }
      }

      // Handle period selection for Goal
      const periodSelectGoal = document.getElementById('periodSelectGoal');
      const subjectSelectGoal = document.getElementById('subjectSelectGoal');

      periodSelectGoal.addEventListener('change', function() {
        const period = this.value;
        subjectSelectGoal.disabled = false;
        subjectSelectGoal.innerHTML = '<option value="">Seleziona una materia...</option>';
        
        if (period && gradesData[period]) {
          const subjects = Object.keys(gradesData[period]).filter(s => s !== 'period_avr');
          subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelectGoal.appendChild(option);
          });
        } else {
          subjectSelectGoal.disabled = true;
          subjectSelectGoal.innerHTML = '<option value="">Prima seleziona un periodo...</option>';
        }
        
        resetTargetAverageInput();
      });

      // Handle subject selection to update target average constraints
      subjectSelectGoal.addEventListener('change', function() {
        const period = periodSelectGoal.value;
        const subject = this.value;
        
        if (period && subject && gradesData[period] && gradesData[period][subject]) {
          const subjectData = gradesData[period][subject];
          const currentAverage = subjectData.avr || 0;
          
          const targetInput = document.getElementById('targetAverage');
          const targetRangeLabel = document.getElementById('targetRangeLabel');
          const targetHelp = document.getElementById('targetHelp');
          
          targetInput.min = Math.max(1, Math.ceil(currentAverage * 10) / 10);
          targetRangeLabel.textContent = `(${targetInput.min}-10)`;
          targetHelp.textContent = `La tua media attuale √® ${currentAverage.toFixed(2)}. Imposta un obiettivo superiore.`;
          
          if (targetInput.value && parseFloat(targetInput.value) < targetInput.min) {
            targetInput.value = '';
          }
        } else {
          resetTargetAverageInput();
        }
      });

      function resetTargetAverageInput() {
        const targetInput = document.getElementById('targetAverage');
        const targetRangeLabel = document.getElementById('targetRangeLabel');
        const targetHelp = document.getElementById('targetHelp');
        
        targetInput.min = 1;
        targetRangeLabel.textContent = '(1-10)';
        targetHelp.textContent = '';
        targetInput.value = '';
      }

      // Handle period selection for Predict
      const periodSelectPredict = document.getElementById('periodSelectPredict');
      const subjectSelectPredict = document.getElementById('subjectSelectPredict');

      periodSelectPredict.addEventListener('change', function() {
        const period = this.value;
        subjectSelectPredict.disabled = false;
        subjectSelectPredict.innerHTML = '<option value="">Seleziona una materia...</option>';
        
        if (period && gradesData[period]) {
          const subjects = Object.keys(gradesData[period]).filter(s => s !== 'period_avr');
          subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelectPredict.appendChild(option);
          });
        } else {
          subjectSelectPredict.disabled = true;
          subjectSelectPredict.innerHTML = '<option value="">Prima seleziona un periodo...</option>';
        }
      });

      // Handle goal form submission
      const goalForm = document.getElementById('goalForm');
      const resultCardGoal = document.getElementById('resultCardGoal');
      const calculateBtnGoal = document.getElementById('calculateBtnGoal');

      goalForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const period = periodSelectGoal.value;
        const subject = subjectSelectGoal.value;
        const targetAverage = parseFloat(document.getElementById('targetAverage').value);

        if (!period || !subject || !targetAverage) {
          showError('Compila tutti i campi!');
          return;
        }

        calculateBtnGoal.disabled = true;
        calculateBtnGoal.textContent = 'Calcolo in corso...';

        try {
          const response = await fetch('/calculate_goal', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              period: period,
              subject: subject,
              target_average: targetAverage,
              num_grades: numGradesGoal
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            displayGoalResult(data);
          } else {
            showError(data.error || 'Errore durante il calcolo');
          }
        } catch (error) {
          showError('Errore di connessione');
        } finally {
          calculateBtnGoal.disabled = false;
          calculateBtnGoal.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Calcola
          `;
        }
      });

      function displayGoalResult(data) {
        document.getElementById('currentAverageGoal').textContent = data.current_average.toFixed(2);
        document.getElementById('targetAverageDisplay').textContent = data.target_average.toFixed(2);
        
        // Display required grades (use 2 decimal places for consistency)
        const requiredGradesEl = document.getElementById('requiredGradesGoal');
        if (data.required_grades && Array.isArray(data.required_grades)) {
          requiredGradesEl.textContent = data.required_grades.map(g => g.toFixed(2)).join(', ');
        } else {
          requiredGradesEl.textContent = data.required_grade.toFixed(2);
        }
        
        document.getElementById('resultMessageGoal').textContent = data.message;

        // Set result card style
        resultCardGoal.classList.remove('success', 'warning', 'error');
        
        const avgGrade = data.required_grades ? 
          data.required_grades.reduce((a, b) => a + b, 0) / data.required_grades.length : 
          data.required_grade;
        
        if (avgGrade < 1) {
          resultCardGoal.classList.add('success');
          document.getElementById('resultEmojiGoal').textContent = 'üéâ';
          document.getElementById('resultTitleGoal').textContent = 'Fantastico!';
        } else if (avgGrade > 10) {
          resultCardGoal.classList.add('error');
          document.getElementById('resultEmojiGoal').textContent = 'üòÖ';
          document.getElementById('resultTitleGoal').textContent = 'Difficile...';
        } else if (avgGrade >= 9) {
          resultCardGoal.classList.add('warning');
          document.getElementById('resultEmojiGoal').textContent = 'üí™';
          document.getElementById('resultTitleGoal').textContent = 'Impegnati!';
        } else if (avgGrade >= 7) {
          resultCardGoal.classList.add('success');
          document.getElementById('resultEmojiGoal').textContent = 'üëç';
          document.getElementById('resultTitleGoal').textContent = 'Fattibile!';
        } else {
          resultCardGoal.classList.add('success');
          document.getElementById('resultEmojiGoal').textContent = '‚úÖ';
          document.getElementById('resultTitleGoal').textContent = 'Ottimo!';
        }

        resultCardGoal.classList.add('show');
        resultCardGoal.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // Handle predict form submission
      const predictForm = document.getElementById('predictForm');
      const resultCardPredict = document.getElementById('resultCardPredict');
      const calculateBtnPredict = document.getElementById('calculateBtnPredict');

      predictForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const period = periodSelectPredict.value;
        const subject = subjectSelectPredict.value;
        const gradeInputs = document.querySelectorAll('.predict-grade-input');
        const predictedGrades = [];
        
        for (let input of gradeInputs) {
          const value = parseFloat(input.value);
          if (!value || value < 1 || value > 10) {
            showError('Inserisci voti validi (1-10)!');
            return;
          }
          predictedGrades.push(value);
        }

        if (!period || !subject || predictedGrades.length === 0) {
          showError('Compila tutti i campi!');
          return;
        }

        calculateBtnPredict.disabled = true;
        calculateBtnPredict.textContent = 'Calcolo in corso...';

        try {
          const response = await fetch('/predict_average', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              period: period,
              subject: subject,
              predicted_grades: predictedGrades
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            displayPredictResult(data);
          } else {
            showError(data.error || 'Errore durante il calcolo');
          }
        } catch (error) {
          showError('Errore di connessione');
        } finally {
          calculateBtnPredict.disabled = false;
          calculateBtnPredict.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Prevedi
          `;
        }
      });

      function displayPredictResult(data) {
        document.getElementById('currentAveragePredict').textContent = data.current_average.toFixed(2);
        document.getElementById('predictedAverage').textContent = data.predicted_average.toFixed(2);
        
        const change = data.predicted_average - data.current_average;
        const changeEl = document.getElementById('averageChange');
        const changeText = change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);
        changeEl.textContent = changeText;
        
        // Color the change based on positive/negative
        if (change > 0) {
          changeEl.style.color = 'var(--excellent)';
        } else if (change < 0) {
          changeEl.style.color = 'var(--fail)';
        } else {
          changeEl.style.color = 'var(--text)';
        }
        
        document.getElementById('resultMessagePredict').textContent = data.message;

        // Set result card style
        resultCardPredict.classList.remove('success', 'warning', 'error');
        
        if (change > 0.5) {
          resultCardPredict.classList.add('success');
          document.getElementById('resultEmojiPredict').textContent = 'üìà';
          document.getElementById('resultTitlePredict').textContent = 'Ottima crescita!';
        } else if (change > 0) {
          resultCardPredict.classList.add('success');
          document.getElementById('resultEmojiPredict').textContent = '‚úÖ';
          document.getElementById('resultTitlePredict').textContent = 'In miglioramento!';
        } else if (change === 0) {
          resultCardPredict.classList.add('warning');
          document.getElementById('resultEmojiPredict').textContent = '‚û°Ô∏è';
          document.getElementById('resultTitlePredict').textContent = 'Stabile';
        } else if (change > -0.5) {
          resultCardPredict.classList.add('warning');
          document.getElementById('resultEmojiPredict').textContent = '‚ö†Ô∏è';
          document.getElementById('resultTitlePredict').textContent = 'Leggero calo';
        } else {
          resultCardPredict.classList.add('error');
          document.getElementById('resultEmojiPredict').textContent = 'üìâ';
          document.getElementById('resultTitlePredict').textContent = 'Attenzione!';
        }

        resultCardPredict.classList.add('show');
        resultCardPredict.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // ===== Overall Average Handlers =====

      // Add grade input for overall goal calculator
      function addOverallGoalGradeInput() {
        numGradesOverallGoal++;
        const container = document.getElementById('overallGoalGradesContainer');
        const gradeGroup = document.createElement('div');
        gradeGroup.className = 'grade-input-group';
        gradeGroup.innerHTML = `
          <span style="font-size: 14px; opacity: 0.8;">${numGradesOverallGoal} ${pluralizeVoto(numGradesOverallGoal)}</span>
          <button type="button" class="remove-grade-btn" onclick="removeOverallGoalGradeInput(this)">√ó</button>
        `;
        container.appendChild(gradeGroup);
      }

      function removeOverallGoalGradeInput(btn) {
        if (numGradesOverallGoal > 1) {
          btn.parentElement.remove();
          numGradesOverallGoal--;
          // Update labels
          const groups = document.querySelectorAll('#overallGoalGradesContainer .grade-input-group');
          groups.forEach((group, index) => {
            const span = group.querySelector('span');
            if (span) {
              span.textContent = `${index + 1} ${pluralizeVoto(index + 1)}`;
            }
          });
        }
      }

      // Add grade input for overall predict calculator
      function addOverallPredictGradeInput() {
        numGradesOverallPredict++;
        const container = document.getElementById('overallPredictGradesContainer');
        const gradeGroup = document.createElement('div');
        gradeGroup.className = 'grade-input-group';
        gradeGroup.innerHTML = `
          <input 
            type="number" 
            class="grade-input-small overall-predict-grade-input" 
            min="1" 
            max="10" 
            step="0.5" 
            placeholder="Voto"
            required
          />
          <button type="button" class="remove-grade-btn" onclick="removeOverallPredictGradeInput(this)">√ó</button>
        `;
        container.appendChild(gradeGroup);
      }

      function removeOverallPredictGradeInput(btn) {
        if (numGradesOverallPredict > 1) {
          btn.parentElement.remove();
          numGradesOverallPredict--;
        }
      }

      // Handle period selection for Overall Goal
      const periodSelectOverallGoal = document.getElementById('periodSelectOverallGoal');
      const subjectSelectOverallGoal = document.getElementById('subjectSelectOverallGoal');

      periodSelectOverallGoal.addEventListener('change', function() {
        const period = this.value;
        subjectSelectOverallGoal.disabled = false;
        subjectSelectOverallGoal.innerHTML = '<option value="">Seleziona una materia...</option>';
        
        if (period && gradesData[period]) {
          const subjects = Object.keys(gradesData[period]).filter(s => s !== 'period_avr');
          subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelectOverallGoal.appendChild(option);
          });
        } else {
          subjectSelectOverallGoal.disabled = true;
          subjectSelectOverallGoal.innerHTML = '<option value="">Prima seleziona un periodo...</option>';
        }
        
        updateOverallTargetInput();
      });

      subjectSelectOverallGoal.addEventListener('change', function() {
        updateOverallTargetInput();
      });

      function updateOverallTargetInput() {
        const targetInput = document.getElementById('targetOverallAverage');
        const targetRangeLabel = document.getElementById('targetOverallRangeLabel');
        const targetHelp = document.getElementById('targetOverallHelp');
        
        const currentOverallAverage = gradesData.all_avr || 0;
        
        targetInput.min = Math.max(1, Math.ceil(currentOverallAverage * 10) / 10);
        targetRangeLabel.textContent = `(${targetInput.min}-10)`;
        targetHelp.textContent = `La tua media generale attuale √® ${currentOverallAverage.toFixed(2)}. Imposta un obiettivo superiore.`;
        
        if (targetInput.value && parseFloat(targetInput.value) < targetInput.min) {
          targetInput.value = '';
        }
      }

      // Handle period selection for Overall Predict
      const periodSelectOverallPredict = document.getElementById('periodSelectOverallPredict');
      const subjectSelectOverallPredict = document.getElementById('subjectSelectOverallPredict');

      periodSelectOverallPredict.addEventListener('change', function() {
        const period = this.value;
        subjectSelectOverallPredict.disabled = false;
        subjectSelectOverallPredict.innerHTML = '<option value="">Seleziona una materia...</option>';
        
        if (period && gradesData[period]) {
          const subjects = Object.keys(gradesData[period]).filter(s => s !== 'period_avr');
          subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelectOverallPredict.appendChild(option);
          });
        } else {
          subjectSelectOverallPredict.disabled = true;
          subjectSelectOverallPredict.innerHTML = '<option value="">Prima seleziona un periodo...</option>';
        }
      });

      // Handle overall goal form submission
      const overallGoalForm = document.getElementById('overallGoalForm');
      const resultCardOverallGoal = document.getElementById('resultCardOverallGoal');
      const calculateBtnOverallGoal = document.getElementById('calculateBtnOverallGoal');

      overallGoalForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const period = periodSelectOverallGoal.value;
        const subject = subjectSelectOverallGoal.value;
        const targetAverage = parseFloat(document.getElementById('targetOverallAverage').value);

        if (!period || !subject || !targetAverage) {
          showError('Compila tutti i campi!');
          return;
        }

        calculateBtnOverallGoal.disabled = true;
        calculateBtnOverallGoal.textContent = 'Calcolo in corso...';

        try {
          const response = await fetch('/calculate_goal_overall', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              period: period,
              subject: subject,
              target_average: targetAverage,
              num_grades: numGradesOverallGoal
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            displayOverallGoalResult(data);
          } else {
            showError(data.error || 'Errore durante il calcolo');
          }
        } catch (error) {
          showError('Errore di connessione');
        } finally {
          calculateBtnOverallGoal.disabled = false;
          calculateBtnOverallGoal.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Calcola
          `;
        }
      });

      function displayOverallGoalResult(data) {
        document.getElementById('currentOverallAverageGoal').textContent = data.current_overall_average.toFixed(2);
        document.getElementById('targetOverallAverageDisplay').textContent = data.target_average.toFixed(2);
        
        const requiredGradesEl = document.getElementById('requiredOverallGrades');
        if (data.required_grades && Array.isArray(data.required_grades)) {
          requiredGradesEl.textContent = data.required_grades.map(g => g.toFixed(2)).join(', ');
        } else {
          requiredGradesEl.textContent = data.required_grade.toFixed(2);
        }
        
        document.getElementById('resultMessageOverallGoal').textContent = data.message;

        // Set result card style
        resultCardOverallGoal.classList.remove('success', 'warning', 'error');
        
        const avgGrade = data.required_grades ? 
          data.required_grades.reduce((a, b) => a + b, 0) / data.required_grades.length : 
          data.required_grade;
        
        if (avgGrade < 1) {
          resultCardOverallGoal.classList.add('success');
          document.getElementById('resultEmojiOverallGoal').textContent = 'üéâ';
          document.getElementById('resultTitleOverallGoal').textContent = 'Fantastico!';
        } else if (avgGrade > 10) {
          resultCardOverallGoal.classList.add('error');
          document.getElementById('resultEmojiOverallGoal').textContent = 'üòÖ';
          document.getElementById('resultTitleOverallGoal').textContent = 'Difficile...';
        } else if (avgGrade >= 9) {
          resultCardOverallGoal.classList.add('warning');
          document.getElementById('resultEmojiOverallGoal').textContent = 'üí™';
          document.getElementById('resultTitleOverallGoal').textContent = 'Impegnati!';
        } else if (avgGrade >= 7) {
          resultCardOverallGoal.classList.add('success');
          document.getElementById('resultEmojiOverallGoal').textContent = 'üëç';
          document.getElementById('resultTitleOverallGoal').textContent = 'Fattibile!';
        } else {
          resultCardOverallGoal.classList.add('success');
          document.getElementById('resultEmojiOverallGoal').textContent = '‚úÖ';
          document.getElementById('resultTitleOverallGoal').textContent = 'Ottimo!';
        }

        resultCardOverallGoal.classList.add('show');
        resultCardOverallGoal.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // Handle overall predict form submission
      const overallPredictForm = document.getElementById('overallPredictForm');
      const resultCardOverallPredict = document.getElementById('resultCardOverallPredict');
      const calculateBtnOverallPredict = document.getElementById('calculateBtnOverallPredict');

      overallPredictForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const period = periodSelectOverallPredict.value;
        const subject = subjectSelectOverallPredict.value;
        const gradeInputs = document.querySelectorAll('.overall-predict-grade-input');
        const predictedGrades = [];
        
        for (let input of gradeInputs) {
          const value = parseFloat(input.value);
          if (!value || value < 1 || value > 10) {
            showError('Inserisci voti validi (1-10)!');
            return;
          }
          predictedGrades.push(value);
        }

        if (!period || !subject || predictedGrades.length === 0) {
          showError('Compila tutti i campi!');
          return;
        }

        calculateBtnOverallPredict.disabled = true;
        calculateBtnOverallPredict.textContent = 'Calcolo in corso...';

        try {
          const response = await fetch('/predict_average_overall', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              period: period,
              subject: subject,
              predicted_grades: predictedGrades
            })
          });

          const data = await response.json();

          if (response.ok && data.success) {
            displayOverallPredictResult(data);
          } else {
            showError(data.error || 'Errore durante il calcolo');
          }
        } catch (error) {
          showError('Errore di connessione');
        } finally {
          calculateBtnOverallPredict.disabled = false;
          calculateBtnOverallPredict.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Prevedi
          `;
        }
      });

      function displayOverallPredictResult(data) {
        document.getElementById('currentOverallAveragePredict').textContent = data.current_overall_average.toFixed(2);
        document.getElementById('predictedOverallAverage').textContent = data.predicted_overall_average.toFixed(2);
        
        const change = data.predicted_overall_average - data.current_overall_average;
        const changeEl = document.getElementById('overallAverageChange');
        const changeText = change >= 0 ? `+${change.toFixed(2)}` : change.toFixed(2);
        changeEl.textContent = changeText;
        
        // Color the change based on positive/negative
        if (change > 0) {
          changeEl.style.color = 'var(--success)';
        } else if (change < 0) {
          changeEl.style.color = 'var(--primary)';
        } else {
          changeEl.style.color = 'var(--text)';
        }
        
        document.getElementById('resultMessageOverallPredict').textContent = data.message;

        // Set result card style
        resultCardOverallPredict.classList.remove('success', 'warning', 'error');
        
        if (change > 0.5) {
          resultCardOverallPredict.classList.add('success');
          document.getElementById('resultEmojiOverallPredict').textContent = 'üìà';
          document.getElementById('resultTitleOverallPredict').textContent = 'Ottima crescita!';
        } else if (change > 0) {
          resultCardOverallPredict.classList.add('success');
          document.getElementById('resultEmojiOverallPredict').textContent = '‚úÖ';
          document.getElementById('resultTitleOverallPredict').textContent = 'In miglioramento!';
        } else if (change === 0) {
          resultCardOverallPredict.classList.add('warning');
          document.getElementById('resultEmojiOverallPredict').textContent = '‚û°Ô∏è';
          document.getElementById('resultTitleOverallPredict').textContent = 'Stabile';
        } else if (change > -0.5) {
          resultCardOverallPredict.classList.add('warning');
          document.getElementById('resultEmojiOverallPredict').textContent = '‚ö†Ô∏è';
          document.getElementById('resultTitleOverallPredict').textContent = 'Leggero calo';
        } else {
          resultCardOverallPredict.classList.add('error');
          document.getElementById('resultEmojiOverallPredict').textContent = 'üìâ';
          document.getElementById('resultTitleOverallPredict').textContent = 'Attenzione!';
        }

        resultCardOverallPredict.classList.add('show');
        resultCardOverallPredict.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // Handle logout from bottom nav
      const logoutNavBtn = document.getElementById('logoutNavBtn');
      if (logoutNavBtn) {
        logoutNavBtn.addEventListener('click', () => {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/logout';
          document.body.appendChild(form);
          form.submit();
        });
      }
    </script>
  </body>
</html>
