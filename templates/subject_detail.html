<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#c84444" />
    <meta name="description" content="Dettaglio materia" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MediaHo" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
    <title>{{ subject_name }} - che media ho?</title>
    <!-- Theme detection - prevent flicker -->
    <script>
      (function() {
        const theme = localStorage.getItem('theme') || 'dark';
        if (theme === 'light') {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/common.css" />
    <link rel="stylesheet" href="/static/css/subject_detail.css" />
  </head>
  <body>
    <!-- Header -->
    <div class="header-section">
      <button class="back-button" onclick="window.location.href='/grades'">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
      </button>
      <div class="header-title">{{ subject_name }}</div>
    </div>

    <!-- Error Notification -->
    <div class="error-notification" id="errorNotification"></div>

    <div class="container">
      <!-- Subject Info Card -->
      <div class="info-card">
        {% set ns = namespace(subject_average=0, total_grades=0, first_found=False, highest_grade=0, lowest_grade=10, grade_types={}) %}
        {% for period in grades_avr.keys() if period != 'all_avr' %}
          {% if subject_name in grades_avr[period] %}
            {% set subject_data = grades_avr[period][subject_name] %}
            {% if not ns.first_found %}
              {% set ns.subject_average = subject_data.avr %}
              {% set ns.first_found = True %}
            {% endif %}
            {% set ns.total_grades = ns.total_grades + subject_data.grades|length %}
            {% for grade in subject_data.grades %}
              {% if grade.decimalValue > ns.highest_grade %}
                {% set ns.highest_grade = grade.decimalValue %}
              {% endif %}
              {% if grade.decimalValue < ns.lowest_grade %}
                {% set ns.lowest_grade = grade.decimalValue %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
        
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Media</div>
            <div class="info-value {% if ns.subject_average >= 6.5 %}excellent{% elif ns.subject_average >= 5.5 %}pass{% else %}fail{% endif %}">
              {{ ns.subject_average | round(1) }}
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Voti Totali</div>
            <div class="info-value">{{ ns.total_grades }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Voto piÃ¹ alto</div>
            <div class="info-value excellent">{{ ns.highest_grade | round(1) }}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Voto piÃ¹ basso</div>
            <div class="info-value {% if ns.lowest_grade >= 6.5 %}excellent{% elif ns.lowest_grade >= 5.5 %}pass{% else %}fail{% endif %}">
              {{ ns.lowest_grade | round(1) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Grades by Period -->
      <div class="section-card">
        <div class="section-title">ðŸ“Š Voti per Periodo</div>
        {% for period in grades_avr.keys() | sort if period != 'all_avr' %}
          {% if subject_name in grades_avr[period] %}
            {% set subject_data = grades_avr[period][subject_name] %}
            <div style="margin-bottom: 20px;">
              <div style="text-align: center; margin-bottom: 12px;">
                <span class="period-badge" style="font-size: 14px;">Periodo {{ period }}</span>
              </div>
              <div class="grades-list">
                {% for grade in subject_data.grades %}
                  <button
                    type="button"
                    class="grade-badge {% if grade.isBlue %}blue{% elif grade.decimalValue >= 6.5 %}excellent{% elif grade.decimalValue >= 5.5 %}pass{% else %}fail{% endif %}"
                    onclick='showModal({{ grade | tojson | safe }})'
                  >
                    {{ grade.decimalValue }}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Time Series Chart -->
      <div class="section-card">
        <div class="section-title">ðŸ“ˆ Andamento nel Tempo</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Visualizza l'evoluzione dei voti in questa materia nel tempo.
        </p>
        <div class="chart-container">
          <canvas id="gradesTrendChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Smart Suggestions Section -->
      <div class="section-card">
        <div class="section-title">ðŸŽ¯ Calcola Obiettivo</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Calcola quale voto ti serve per raggiungere la media desiderata in questa materia.
        </p>
        
        <!-- Saved Goal Display -->
        <div id="savedGoalDisplay" style="display: none; background: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--excellent); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Obiettivo Salvato</div>
          <div id="savedGoalContent" style="font-size: 14px; opacity: 0.9;"></div>
          <button onclick="clearSavedGoal()" style="margin-top: 12px; padding: 6px 12px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 6px; color: var(--text); cursor: pointer; font-size: 13px;">
            Cancella Obiettivo
          </button>
        </div>
        
        <form id="goalForm">
          <div class="form-group">
            <label class="form-label" for="periodSelect">Periodo</label>
            <select class="form-select" id="periodSelect" required>
              <option value="">Seleziona un periodo...</option>
              {% for period in grades_avr.keys() | sort if period != 'all_avr' %}
                {% if subject_name in grades_avr[period] %}
                  <option value="{{ period }}">Periodo {{ period }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="targetAverage">Media Target</label>
            <input 
              type="number" 
              class="form-input" 
              id="targetAverage" 
              min="1" 
              max="10" 
              step="0.1" 
              placeholder="Es: 7.5"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="numGrades">Numero di Voti</label>
            <input 
              type="number" 
              class="form-input" 
              id="numGrades" 
              min="1" 
              max="10" 
              value="1"
              required
            />
          </div>

          <button type="submit" class="calculate-btn" id="calculateBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Calcola
          </button>
        </form>

        <!-- Result Card -->
        <div class="result-card" id="resultCard">
          <div class="result-content">
            <div class="result-row">
              <span class="result-label">Media Attuale</span>
              <span class="result-value" id="currentAverage">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Media Target</span>
              <span class="result-value" id="targetAverageDisplay">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Voti Necessari</span>
              <span class="result-value highlight" id="requiredGrades">-</span>
            </div>
          </div>
          <div class="result-message" id="resultMessage"></div>
        </div>
      </div>

      <!-- Predictions Section -->
      <div class="section-card">
        <div class="section-title">ðŸ”® Previsioni</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Simula l'impatto di nuovi voti sulla media di questa materia.
        </p>
        
        <form id="predictionsForm">
          <div class="form-group">
            <label class="form-label" for="predictPeriod">Periodo</label>
            <select class="form-select" id="predictPeriod" required>
              <option value="">Seleziona un periodo...</option>
              {% for period in grades_avr.keys() | sort if period != 'all_avr' %}
                {% if subject_name in grades_avr[period] %}
                  <option value="{{ period }}">Periodo {{ period }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="predictGrades">Voti Previsti (separati da virgola)</label>
            <input 
              type="text" 
              class="form-input" 
              id="predictGrades" 
              placeholder="Es: 7.5, 8, 9"
              required
            />
          </div>

          <button type="submit" class="calculate-btn" id="predictBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Simula
          </button>
        </form>

        <!-- Prediction Result Card -->
        <div class="result-card" id="predictionResult">
          <div class="result-content" id="predictionContent">
            <!-- Prediction details will be populated here -->
          </div>
          <div class="result-message" id="predictionMessage"></div>
        </div>
      </div>
    </div>

    <!-- Grade Detail Modal -->
    <div id="gradeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header">Dettagli Voto</div>
        <div id="modalBody"></div>
      </div>
    </div>

    <script>
      // Inject data from backend for subject_detail.js
      window.gradesData = {{ grades_avr | tojson }};
      window.subjectName = {{ subject_name | tojson }};
    </script>
    <script src="/static/js/subject_detail.js"></script>
  </body>
</html>
