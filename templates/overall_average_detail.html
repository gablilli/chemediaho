<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#c84444" />
    <meta name="description" content="Dettaglio media generale" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MediaHo" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png" />
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
    <title>Media Generale - che media ho?</title>
    <!-- Theme detection - prevent flicker -->
    <script src="/static/js/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/static/common.css" />
    <link rel="stylesheet" href="/static/css/overall_average_detail.css" />
  </head>
  <body>
    <!-- Header -->
    <div class="header-section">
      <button class="back-button" onclick="window.location.href='/grades'">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
      </button>
      <div class="header-title">Media Generale</div>
    </div>

    <!-- Error Notification -->
    <div class="error-notification" id="errorNotification"></div>

    <div class="container">
      <!-- Average Display -->
      <div class="average-display">
        <div class="circle-grade-wrapper-large">
          <svg class="circle-progress-large">
            <circle class="circle-progress-bg-large" cx="70" cy="70" r="60"></circle>
            <circle 
              class="circle-progress-fill-large {% if grades_avr['all_avr'] >= 6.5 %}excellent{% elif grades_avr['all_avr'] >= 5.5 %}pass{% else %}fail{% endif %}"
              cx="70" 
              cy="70" 
              r="60"
              stroke-dasharray="377"
              stroke-dashoffset="377"
              data-target="{{ (grades_avr['all_avr'] / 10 * 377) | round }}"
            ></circle>
          </svg>
          <div class="circle-grade-large {% if grades_avr['all_avr'] >= 6.5 %}grade-excellent{% elif grades_avr['all_avr'] >= 5.5 %}grade-pass{% else %}grade-fail{% endif %}">
            {{ grades_avr["all_avr"] | round(1) }}
          </div>
        </div>
        <div class="average-label">Media Generale</div>
      </div>

      <!-- Smart Suggestions Section -->
      <div class="section-card">
        <div class="section-title">ðŸŽ¯ Suggerimenti Intelligenti</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Scopri quali materie ti permetteranno di raggiungere la tua media target piÃ¹ facilmente.
        </p>
        
        <!-- Saved Goal Display -->
        <div id="savedGoalDisplay" style="display: none; background: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--excellent); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Obiettivo Salvato</div>
          <div id="savedGoalContent" style="font-size: 14px; opacity: 0.9;"></div>
          <button onclick="clearSavedGoal()" style="margin-top: 12px; padding: 6px 12px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 6px; color: var(--text); cursor: pointer; font-size: 13px;">
            Cancella Obiettivo
          </button>
        </div>
        
        <form id="smartSuggestionsForm">
          <div class="form-group">
            <label class="form-label" for="targetAverage">Media Generale Target</label>
            <input 
              type="number" 
              class="form-input" 
              id="targetAverage" 
              min="1" 
              max="10" 
              step="0.1" 
              placeholder="Es: 8.0"
              required
            />
          </div>

          <button type="submit" class="calculate-btn" id="calculateBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Calcola Suggerimenti
          </button>
        </form>

        <!-- Result Card -->
        <div class="result-card" id="resultCard">
          <div class="result-header">
            <div class="result-icon">
              <span>ðŸŽ¯</span>
            </div>
            <div class="result-title">Piano Ottimale</div>
          </div>
          <div id="suggestionsContainer">
            <!-- Suggestions will be populated here -->
          </div>
          <div class="result-message" id="resultMessage"></div>
        </div>
      </div>

      <!-- Predictions Section -->
      <div class="section-card">
        <div class="section-title">ðŸ”® Previsioni</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Simula l'impatto di nuovi voti sulla tua media generale.
        </p>
        
        <form id="predictionsForm">
          <div class="form-group">
            <label class="form-label" for="predictSubject">Materia</label>
            <select class="form-select" id="predictSubject" required>
              <option value="">Seleziona una materia...</option>
              {% for period in grades_avr.keys() if period != 'all_avr' %}
                {% for subject in grades_avr[period].keys() if subject != 'period_avr' %}
                  <option value="{{ subject }}|{{ period }}">{{ subject }} (Periodo {{ period }})</option>
                {% endfor %}
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="predictGrades">Voti Previsti (separati da virgola)</label>
            <input 
              type="text" 
              class="form-input" 
              id="predictGrades" 
              placeholder="Es: 7.5, 8, 9"
              required
            />
          </div>

          <button type="submit" class="calculate-btn" id="predictBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Simula
          </button>
        </form>

        <!-- Prediction Result Card -->
        <div class="result-card" id="predictionResult">
          <div class="result-header">
            <div class="result-icon">
              <span>ðŸ”®</span>
            </div>
            <div class="result-title">Risultato Simulazione</div>
          </div>
          <div class="result-content" id="predictionContent">
            <!-- Prediction details will be populated here -->
          </div>
          <div class="result-message" id="predictionMessage"></div>
        </div>
      </div>

      <!-- Time Series Chart -->
      <div class="section-card">
        <div class="section-title">ðŸ“ˆ Andamento Media Generale</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Visualizza l'evoluzione della media generale per periodo.
        </p>
        <div class="chart-container">
          <canvas id="overallTrendChart" class="chart-canvas"></canvas>
        </div>
      </div>
    </div>

    <script>
      // Inject data from backend for overall_average_detail.js
      window.gradesData = {{ grades_avr | tojson }};
    </script>
    <script src="/static/js/classeviva-api.js"></script>
    <script src="/static/js/overall_average_detail.js"></script>
  </body>
</html>
