<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#c84444" />
    <meta name="description" content="Dettaglio materia" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="chemediaho?" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png" />
    <title>Dettaglio Materia - che media ho?</title>
    <script src="js/config.runtime.js"></script>
    <script src="js/api.js"></script>
    <script src="js/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="common.css" />
    <link rel="stylesheet" href="css/subject_detail.css" />
  </head>
  <body>
    <!-- Header -->
    <div class="header-section">
      <button class="back-button" onclick="navigateTo('grades.html')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
      </button>
      <div class="header-title" id="subjectTitle">Caricamento...</div>
    </div>

    <!-- Error Notification -->
    <div class="error-notification" id="errorNotification"></div>

    <div class="container">
      <!-- Subject Info Card -->
      <div class="info-card">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Media</div>
            <div class="info-value" id="subjectAverage">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Voti Totali</div>
            <div class="info-value" id="totalGrades">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Voto piÃ¹ alto</div>
            <div class="info-value excellent" id="highestGrade">-</div>
          </div>
          <div class="info-item">
            <div class="info-label">Voto piÃ¹ basso</div>
            <div class="info-value" id="lowestGrade">-</div>
          </div>
        </div>
      </div>

      <!-- Grades by Period -->
      <div class="section-card">
        <div class="section-title">ðŸ“Š Voti per Periodo</div>
        <div id="gradesByPeriod">
          <!-- Will be populated by JavaScript -->
          <div class="loading-message">Caricamento voti...</div>
        </div>
      </div>

      <!-- Time Series Chart -->
      <div class="section-card">
        <div class="section-title">ðŸ“ˆ Andamento nel Tempo</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Visualizza l'evoluzione dei voti in questa materia nel tempo.
        </p>
        <div class="chart-container">
          <canvas id="gradesTrendChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Smart Suggestions Section -->
      <div class="section-card">
        <div class="section-title">ðŸŽ¯ Calcola Obiettivo</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Calcola quale voto ti serve per raggiungere la media desiderata in questa materia.
        </p>
        
        <!-- Saved Goal Display -->
        <div id="savedGoalDisplay" style="display: none; background: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--excellent); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <div style="font-weight: 600; margin-bottom: 8px;">ðŸŽ¯ Obiettivo Salvato</div>
          <div id="savedGoalContent" style="font-size: 14px; opacity: 0.9;"></div>
          <button onclick="clearSavedGoal()" style="margin-top: 12px; padding: 6px 12px; background: rgba(255, 255, 255, 0.1); border: none; border-radius: 6px; color: var(--text); cursor: pointer; font-size: 13px;">
            Cancella Obiettivo
          </button>
        </div>
        
        <form id="goalForm">
          <div class="form-group">
            <label class="form-label" for="periodSelect">Periodo</label>
            <select class="form-select" id="periodSelect" required>
              <option value="">Seleziona un periodo...</option>
              <!-- Will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="targetAverage">Media Target</label>
            <input 
              type="number" 
              class="form-input" 
              id="targetAverage" 
              min="1" 
              max="10" 
              step="0.1" 
              placeholder="Es: 7.5"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label" for="numGrades">Numero di Voti</label>
            <input 
              type="number" 
              class="form-input" 
              id="numGrades" 
              min="1" 
              max="10" 
              value="1"
              required
            />
          </div>

          <button type="submit" class="calculate-btn" id="calculateBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            Calcola
          </button>
        </form>

        <!-- Result Card -->
        <div class="result-card" id="resultCard">
          <div class="result-content">
            <div class="result-row">
              <span class="result-label">Media Attuale</span>
              <span class="result-value" id="currentAverage">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Media Target</span>
              <span class="result-value" id="targetAverageDisplay">-</span>
            </div>
            <div class="result-row">
              <span class="result-label">Voti Necessari</span>
              <span class="result-value highlight" id="requiredGrades">-</span>
            </div>
          </div>
          <div class="result-message" id="resultMessage"></div>
        </div>
      </div>

      <!-- Predictions Section -->
      <div class="section-card">
        <div class="section-title">ðŸ”® Previsioni</div>
        <p style="opacity: 0.8; margin-bottom: 16px;">
          Simula l'impatto di nuovi voti sulla media di questa materia.
        </p>
        
        <form id="predictionsForm">
          <div class="form-group">
            <label class="form-label" for="predictPeriod">Periodo</label>
            <select class="form-select" id="predictPeriod" required>
              <option value="">Seleziona un periodo...</option>
              <!-- Will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label class="form-label" for="predictGrades">Voti Previsti (separati da virgola)</label>
            <input 
              type="text" 
              class="form-input" 
              id="predictGrades" 
              placeholder="Es: 7.5, 8, 9"
              required
            />
          </div>

          <button type="submit" class="calculate-btn" id="predictBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Simula
          </button>
        </form>

        <!-- Prediction Result Card -->
        <div class="result-card" id="predictionResult">
          <div class="result-content" id="predictionContent">
            <!-- Prediction details will be populated here -->
          </div>
          <div class="result-message" id="predictionMessage"></div>
        </div>
      </div>
    </div>

    <!-- Grade Detail Modal -->
    <div id="gradeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-header">Dettagli Voto</div>
        <div id="modalBody"></div>
      </div>
    </div>

    <script src="js/subject_detail.js"></script>
  </body>
</html>
